apiVersion: v1
kind: Pod
metadata:
  name: ubiquia-core-communication-service-test
  namespace: ubiquia
  annotations:
    "helm.sh/hook": test
  labels:
    sidecar.istio.io/inject: "false"
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:8.6.0
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e

          test_endpoint() {
            local METHOD=$1
            local URL=$2
            local EXPECT_CODE=$3
            local NAME=$4

            echo "Testing $NAME ($METHOD $URL)..."

            local RESPONSE_FILE=$(mktemp)
            local STATUS=$(curl -s -o "$RESPONSE_FILE" -w "%{http_code}" -X "$METHOD" "$URL")
            local BODY=$(cat "$RESPONSE_FILE")
            rm "$RESPONSE_FILE"

            if [ "$STATUS" != "$EXPECT_CODE" ]; then
              echo "‚ùå $NAME failed (expected $EXPECT_CODE, got $STATUS)"
              echo "üîç Response body:"
              echo "$BODY"
              exit 1
            fi

            echo "‚úÖ $NAME passed (HTTP $STATUS)"
          }

          test_endpoint_allowing_any_non_404() {
            local METHOD=$1
            local URL=$2
            local NAME=$3

            echo "Testing $NAME ($METHOD $URL)..."

            local RESPONSE_FILE=$(mktemp)
            local STATUS=$(curl -s -o "$RESPONSE_FILE" -w "%{http_code}" -X "$METHOD" "$URL")
            local BODY=$(cat "$RESPONSE_FILE")
            rm "$RESPONSE_FILE"

            if [ "$STATUS" = "404" ]; then
              echo "‚ùå $NAME failed (404 Not Found)"
              echo "üîç Response body:"
              echo "$BODY"
              exit 1
            fi

            echo "‚úÖ $NAME passed (HTTP $STATUS)"
          }

          BASE_URL="http://ubiquia-core-communication-service:8080"

          # -- Health check --
          test_endpoint GET "$BASE_URL/actuator/health" 200 "Health Check"

          # -- Belief state generator --
          test_endpoint_allowing_any_non_404 POST "$BASE_URL/ubiquia/core/communication-service/belief-state-generator-service/belief-state/generate" "Generate Belief State"
          test_endpoint_allowing_any_non_404 POST "$BASE_URL/ubiquia/core/communication-service/belief-state-generator-service/belief-state/teardown" "Teardown Belief State"

          # -- Proxy to flow-service --
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/agent/instance/get" "Proxy: Get Instance"
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/component/query/params?page=0&size=1" "Proxy: Get Query Params for Components"
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/domain-ontology/query/params?page=0&size=1" "Proxy: Get Query Params for Domain Ontologies"
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/event/query/params?page=0&size=1" "Proxy: Get Query Params for Events"
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/graph/query/params?page=0&size=1" "Proxy: Get Query Params for Graphs"
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/node/query/params?page=0&size=1" "Proxy: Get Query Params for Nodes"

          AGENT_ID=test-agent-id
          test_endpoint_allowing_any_non_404 GET "$BASE_URL/ubiquia/core/communication-service/flow-service/agent/${AGENT_ID}/get-deployed-graph-ids?page=0&size=10" "Proxy: Get Deployed Graph IDs"

          echo "üéâ All endpoint checks passed!"
