name: ubiquia-workbench
modelType: Graph
author: Jeremy Case
description: A DAG that ships with Ubiquia that can be used to generate new ACLs and DAGs

version:
  major: 1
  minor: 1
  patch: 0

tags:

capabilities:
 - AclGeneration
 - DagGeneration

agentCommunicationLanguage:
  name: ubiquia-workbench
  version:
    major: 1
    minor: 1
    patch: 0

components:

  - name: Workbench-UI

    componentType: POD
    modelType: Component
    description: This UI will allow clients to prompt Ubiquia to generate new ACLs and DAGs for those problem domains.

    communicationServiceSettings:
      exposeViaCommService: true
      proxiedEndpoint: /index.html

    port: 8080

    image:
      registry: ubiquia
      repository: dag-workbench-ui
      tag: latest

    overrideSettings:

  - name: Workbench-Whisperer

    componentType: POD
    modelType: Component
    description: This component contains several endpoints that can be used to interface successfully with the Workbench LLM.

    port: 8080

    image:
      registry: ubiquia
      repository: dag-workbench-whisperer
      tag: latest

    overrideSettings:

  - name: Workbench-LLM

    componentType: POD
    modelType: Component
    description: An LLM for our workbench.

    port: 11434

    image:
      registry: ollama
      repository: ollama
      tag: 0.11.5

    overrideSettings:

    postStartExecCommands:
      - /bin/sh
      - -c
      - |
        set -eu
        echo "Waiting for Ollama..."
        i=0
        while [ "$i" -lt 360 ]; do
          if ollama list >/dev/null 2>&1; then
            echo "Daemon up. Pulling model..."
            ollama pull llama3.2
            exit 0
          fi
          i=$((i+1))
          sleep 1
        done
        echo "Ollama not ready after 360s" >&2
        exit 1

componentlessAdapters:

  - modelType: Adapter
    adapterType: PUSH
    name: Workbench-User-Prompt-Adapter
    description: SENPAI!

    communicationServiceSettings:
      exposeViaCommService: true

    endpoint: http://workbench-whisperer:8080/wrap

    inputSubSchemas:
      - modelName: UserPrompt

    outputSubSchema:
      modelName: LlamaInput
    
    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: true
      validateInputPayload: true
      stimulateInputPayload: false

  - modelType: Adapter
    adapterType: HIDDEN
    name: Json-Schema-Generator-Adapter
    description: An adapter that forwards traffic to our LLM

    endpoint: http://workbench-llm:11434/api/generate

    inputSubSchemas:
      - modelName: LlamaInput

    outputSubSchema:
      modelName: LlamaOutput
    
    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: false
      stimulateInputPayload: false

  - modelType: Adapter
    adapterType: HIDDEN
    name: Acl-Wrapper-Adapter
    description: An adapter that wraps our generated JSON Schema into an ACL

    endpoint: http://workbench-whisperer:8080/acl/from-llama-output

    inputSubSchemas:
      - modelName: LlamaOutput

    outputSubSchema:
      modelName: GeneratedAgentCommunicationLanguage
    
    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: false
      stimulateInputPayload: false

  - modelType: Adapter
    adapterType: HIDDEN
    name: Acl-Registration-Adapter
    description: This adapter will attempt to register LLM-generated ACLs with Ubiquia.

    endpoint: http://ubiquia-core-flow-service:8080/ubiquia/flow-service/agent-communication-language/register/post

    inputSubSchemas:
      - modelName: GeneratedAgentCommunicationLanguage

    outputSubSchema:
      modelName: IngressResponse

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true
    
  - modelType: Adapter
    adapterType: HIDDEN
    name: Acl-Query-Adapter
    description: This adapter will query adapters 

    endpoint: http://workbench-whisperer:8080/ingress/relay

    inputSubSchemas:
      - modelName: IngressResponse

    outputSubSchema:
      modelName: GeneratedAgentCommunicationLanguage

    egressSettings:
      httpOutputType: POST
      egressType: SYNCHRONOUS
      egressConcurrency: 1

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true

  - modelType: Adapter
    adapterType: HIDDEN
    name: Acl-Belief-State-Generation
    description: This adapter  

    endpoint: http://workbench-whisperer:8080/acl/to-belief-state-generation

    inputSubSchemas:
      - modelName: GeneratedAgentCommunicationLanguage

    outputSubSchema:
      modelName: BeliefStateGeneration

    egressSettings:
      httpOutputType: POST
      egressType: SYNCHRONOUS
      egressConcurrency: 1

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true

  - modelType: Adapter
    adapterType: EGRESS
    name: Acl-Belief-State-Instantiate
    description: This adapter will instantiate the generated belief state 

    endpoint: http://ubiquia-core-belief-state-generator-service:8080/ubiquia/belief-state-generator/belief-state/generate

    inputSubSchemas:
      - modelName: BeliefStateGeneration

    outputSubSchema:
      modelName: BeliefStateGeneration

    egressSettings:
      httpOutputType: POST
      egressType: SYNCHRONOUS
      egressConcurrency: 1

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true

  - modelType: Adapter
    adapterType: HIDDEN
    name: Dag-Prompt-Generator-Adapter
    description: This adapter will prompt our LLM to generate a DAG 

    endpoint: http://workbench-whisperer:8080/wrap-dag

    inputSubSchemas:
      - modelName: GeneratedAgentCommunicationLanguage

    outputSubSchema:
      modelName: LlamaInput

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true

  - modelType: Adapter
    adapterType: HIDDEN
    name: Dag-Generator-Adapter
    description: This adapter will prompt our LLM to generate a DAG 

    endpoint: http://workbench-llm:11434/api/generate

    inputSubSchemas:
      - modelName: LlamaInput

    outputSubSchema:
      modelName: LlamaOutput

    adapterSettings:
      persistInputPayload: true
      persistOutputPayload: true
      validateOutputPayload: false
      validateInputPayload: true

edges:
  - leftAdapterName: Workbench-User-Prompt-Adapter
    rightAdapterNames:
      - Json-Schema-Generator-Adapter
  - leftAdapterName: Json-Schema-Generator-Adapter
    rightAdapterNames:
      - Acl-Wrapper-Adapter
  - leftAdapterName: Acl-Wrapper-Adapter
    rightAdapterNames:
      - Acl-Registration-Adapter
  - leftAdapterName: Acl-Registration-Adapter
    rightAdapterNames:
      - Acl-Query-Adapter
  - leftAdapterName: Acl-Query-Adapter
    rightAdapterNames:
      - Acl-Belief-State-Generation
      - Dag-Prompt-Generator-Adapter
  - leftAdapterName: Acl-Belief-State-Generation
    rightAdapterNames:
      - Acl-Belief-State-Instantiate
  - leftAdapterName: Dag-Prompt-Generator-Adapter
    rightAdapterNames:
      - Dag-Generator-Adapter